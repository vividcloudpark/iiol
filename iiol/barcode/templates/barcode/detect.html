{% extends 'base.html' %}

{% load static %}
{% load django_bootstrap5 %}
{%  bootstrap_css %}
{%  bootstrap_javascript %}

{% block content %}

<style>
    canvas.drawing, canvas.drawingBuffer {
        position: absolute;
        left: 0;
        top: 0;
    }
</style>

<div class="container col-md-8 ">
        <div class="card mt-5">
            <div class="card-header">
                <h2>ISBNìœ¼ë¡œ ê²€ìƒ‰</h2>
            </div>
            <div class="card-body">
            
            <form action="{% url 'barcode:detect' %}" method="POST" enctype="multipart/form-data">{% csrf_token %}
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <h3>ê²€ìƒ‰í•  ë„ì„œê´€ ì§€ì—­</h3>
                        <div class="flex=container flex-start" style="display:flex; justify-content:left;" >
                            <div>
                                <select name="big_region" id="selectbox-big_region"></select>
                            </div>
                            <div>
                                <select name="small_region_code" id="selectbox-small_region_code"></select>
                            </div>
                        </div>
                    </li>
                    <li class="list-group-item">
                        <h3>ISBN ë°±ì—”ë“œì—ì„œ ì¶”ì¶œ(*)</h3>
                       <div>
                            <input id="inputbox-photo" type ="file" name="barcode_photo" accept="image/*">
                        </div>
                    </li>

                    {% comment %} <li class="list-group-item">
                        <h3>ë°”ì½”ë“œ ë¦¬ë”</h3>
                        <div id="reader" width="600px" height="600px">
                            <input type="file" id="qr-input-file" accept="image/*" capture>
                        </div>
                    </li> {% endcomment %}


                    <li class="list-group-item">
                        <h3>ISBN ì…ë ¥</h3>
                        <div>
                            <input pattern="[0-9]*" id="inputbox-ISBN" class="form-control" type ="number" name="isbn13"  accept="text/*" href="*">
                        </div>
                    </li>
                    <li class="list-group-item">
                        <button type="submit"> ê²€ìƒ‰! </button>
                    </li>
                </ul>
                
            </form>
        </div>
</div>



<script type="text/javascript" src="{% static "barcode/js/RegionJsonManger.js" %}"></script>
<script>
    
    const RegionJsonApiUrl = '{% url 'barcode:region_code' %}'
    const LoginApiUrl = '{% url 'accounts:login' %}';
    const UserInfoApiUrl = '{% url 'accounts:info' %}';
    const UserProfileEditUrl = '{% url 'accounts:profile_edit' %}';
    const UserSignUpUrl = '{% url 'accounts:signup' %}';
    //ë„ì„œê´€ ë¶„ë¥˜ JSON í˜¸ì¶œ ë° Option ìƒì„±
    callRegionJsonAndAppendToOptions(RegionJsonApiUrl);
    
    //Loginì—¬ë¶€ í™•ì¸ ë° Loginí–ˆì„ê²½ìš° ê¸°ë³¸ë„ì„œê´€ ì„¤ì •
    checkAndGetUserLibData();
    
    async function checkAndGetUserLibData(){
        try{
            const logined = await isLogined(LoginApiUrl);
            if (logined){
                const user_data = await getUserInfo(UserInfoApiUrl);
                if (user_data.my_region != null){
                    document.getElementById("selectbox-big_region").value = user_data.my_region.substring(0,2);
                    document.getElementById("selectbox-small_region_code").value = user_data.my_region;
                    showToast(message=`ì•ˆë…•í•˜ì„¸ìš”, ${user_data.username}ë‹˜, \n í”„ë¡œí•„ì— ì„¤ì •í•œ ì§€ì—­ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.ğŸ‰`,
                            url=UserProfileEditUrl);
                }else{
                    showToast(message=`${user_data.username}ë‹˜, \n í”„ë¡œí•„ì— ë‚´ ë„ì„œê´€ì„ ì„¤ì •í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒ, \n ì•Œê³ ê³„ì…¨ë‚˜ìš”?ğŸ˜‰`,
                                url=UserProfileEditUrl);
                }
            }
        } catch (err) {
            showToast(message='ë„ì„œê´€ ì§€ì—­ ì„¤ì •ì´ ë¶ˆí¸í•˜ì§€ ì•Šìœ¼ì„¸ìš”? \n íšŒì›ê°€ì…ì‹œ ê¸°ë³¸ ì§€ì—­ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! (í´ë¦­)ğŸ“',
                        url = LoginApiUrl);
            console.error(err);
        }
    }

</script>



{% comment %} <script src="{% static 'barcode/js/quagga.min.js' %}"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>

    const html5QrCode = new Html5Qrcode(/* element id */ "reader", { formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13]});
    
    // File based scanning
    const fileinput = document.getElementById('qr-input-file');
    fileinput.addEventListener('change', e => {
        if (e.target.files.length == 0) {
            // No file selected, ignore 
            return;
        }

        const imageFile = e.target.files[0];
        // Scan QR Code
        html5QrCode.scanFileV2(imageFile, true)
        .then(decodedText => {
            document.getElementById('inputbox-ISBN').innerHTML = decodedText;
        })
        .catch(err => {
            // failure, handle it.
            console.log(`Error scanning file. Reason: ${err}`)
        });
    });



    function onScanSuccess(decodedText, decodedResult) {
        
        // handle the scanned code as you like, for example:
        console.log(`Code matched = ${decodedText}`, decodedResult);
        document.getElementById('inputbox-ISBN').innerHTML = decodedResult;
    }
      
    function onScanFailure(error) {
        // handle scan failure, usually better to ignore and keep scanning.
        // for example:
        document.getElementById('inputbox-ISBN').innerText = "ì°¾ëŠ”ì¤‘ì…ë‹ˆë‹¤";
    }

    let config = { 
        fps : 10, 
        qrbox : { width: 400, height: 150 },
        formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13 ],
        videoConstraints: {
            width: 1920,
            height: 1080,
            facingMode: "environment",
        },
    }
    let html5QrcodeScanner = new Html5QrcodeScanner(
    "reader",
    config,
    /* verbose= */ false);
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);

</script>
 {% endcomment %}

{% endblock content %}
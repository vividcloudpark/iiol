{% extends 'base.html' %}

{% load static %}
{% load django_bootstrap5 %}
{%  bootstrap_css %}
{%  bootstrap_javascript %}

{% block content %}

<style>
    canvas.drawing, canvas.drawingBuffer {
        position: absolute;
        left: 0;
        top: 0;
    }
</style>

<div class="container col-md-8 ">
        <div class="card mt-5">
            <div class="card-header">
                <h2>ISBN으로 검색</h2>
            </div>
            <div class="card-body">
            
            <form action="{% url 'barcode:detect' %}" method="POST" enctype="multipart/form-data">{% csrf_token %}
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <h3>검색할 도서관 지역</h3>
                        <div class="flex=container flex-start" style="display:flex; justify-content:left;" >
                            <div>
                                <select name="big_region" id="selectbox-big_region"></select>
                            </div>
                            <div>
                                <select name="small_region_code" id="selectbox-small_region_code"></select>
                            </div>
                        </div>
                    </li>
                     {% comment %} <li id = 'barcode-reader' class="list-group-item">
                        바코드 리더기 - by [https://scanapp.org/html5-qrcode-docs/docs/intro]
                        <div id="reader">
                            <input type="file" id="qr-input-file" accept="image/*" capture>
                        </div>
                    </li>  {% endcomment %}
                    <li class="list-group-item">
                        <h3>ISBN 백엔드에서 추출(*)</h3>
                       <div>
                            <input id="inputbox-photo" type ="file" name="barcode_photo" accept="image/*">
                        </div>
                    </li>
                    
                    {% comment %}
                    <li class="list-group-item">
                        Quagga
                       <div id="scanner-container">
                            <div id="scanner-container-canvas"></div>
                            <input type="button" id="quaggaBtn" value="Start/Stop the scanner" />
                        </div>
                    </li>
                    {% endcomment %}

                    <li class="list-group-item">
                        <h3>ISBN 입력</h3>
                        <div>
                            <input pattern="[0-9]*" id="inputbox-ISBN" class="form-control" type ="number" name="isbn13"  accept="text/*" href="*">
                        </div>
                    </li>
                    <li class="list-group-item">
                        <button type="submit"> 검색! </button>
                    </li>
                </ul>
                
            </form>
        </div>
</div>

 <script>
        // 도서관 대분류, 중분류 
        let apiUrl = '{% url 'barcode:region_code' %}';
        var regionJson;

        const bigRegionSelect = document.getElementById("selectbox-big_region");
        const smallRegionSelect = document.getElementById("selectbox-small_region_code");
        fetch(apiUrl)
        .then(response => {
            // HTTP 상태 코드 확인
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(jsonData=> {
            regionJson = jsonData;
            //지역코드 - 대분류 추가


            // Populate the "big" region select box
            for (const [bigcode, bigValue] of Object.entries(jsonData.big)) {
                const bigOption = document.createElement("option");
                bigOption.text = bigValue;
                bigOption.value = bigcode;
                bigRegionSelect.appendChild(bigOption);
            }
            bigRegionSelect.addEventListener("change", populateSmallRegion);
            populateSmallRegion();

        })
        .catch(error => {
            // 오류 처리 코드
            console.error('Fetch error:', error);
        });

        function populateSmallRegion() {
            // Clear the current options in the "small" region select box
            smallRegionSelect.innerHTML = "";


            const selectedBigRegion = bigRegionSelect.value;

            if (selectedBigRegion in regionJson.small) {
                const smallRegionData = regionJson.small[selectedBigRegion];
                // Populate the "small" region select box based on the selected "big" region
                for (const [smallcode, smallValue] of Object.entries(smallRegionData)) {
                    const smallOption = document.createElement("option");
                    smallOption.text = smallValue;
                    smallOption.value = smallcode;
                    smallRegionSelect.appendChild(smallOption);
                }
            }
        }
</script>

{% comment %} <script src="{% static 'barcode/js/quagga.min.js' %}"></script> {% endcomment %}

{% comment %} <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script> 
<script>
    let _scannerIsRunning = false;
    function startScanner() {
        Quagga.init({
            inputStream : {
                name : "Live",
                type : "LiveStream",
                locate : true,
                numOfWorkers: 4,
                frequency: 10,
                locator: {
                    "patchSize": "medium",
                    "halfSample": true
                },
                target: document.querySelector('#scanner-container-canvas'), // 바코드 이미지를 업로드할 input 요소
                focusMode : 'continuous',
                constraints: {
                    width: 480,
                    height: 320,
                    aspectRatio: 1,
                    // deviceId: selectedDevice ? selectedDevice : "default",
                    //...(cameraId === 'default' ? { facingMode: 'environment' } : { deviceId: cameraId })
                },
                decoder: {
                    readers: ["ean_reader"],
                    debug: {
                        drawBoundingBox: true
                    }
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    return;
                }
                console.log("Initialization finished. Starting Quagga...");
                Quagga.start();
            }
        });
    }

    Quagga.onProcessed(function(result) {
        var drawingCtx = Quagga.canvas.ctx.overlay,
            drawingCanvas = Quagga.canvas.dom.overlay;

        if (result) {
            if (result.boxes) {
                drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                result.boxes.filter(function (box) {
                    return box !== result.box;
                }).forEach(function (box) {
                    Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                });
            }

            if (result.box) {
                Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
            }

            if (result.codeResult && result.codeResult.code) {
                document.querySelector('#inputbox-ISBN').textContent = result.codeResult.code;
                Quagga.stop();
            }
        }
    });

    document.getElementById("quaggaBtn").addEventListener("click", function () {
        if (_scannerIsRunning) {
            _scannerIsRunning = false;
            Quagga.stop();
        } else {
            _scannerIsRunning = true;
            startScanner();
        }
    }, false);

    // 바코드 스캔 중지 시 이벤트 처리
    Quagga.onDetected(function(result) {
        if (result.codeResult) {
            alert("꺅", result.codeResult.code);
            console.log("Barcode detected and processed: " + result.codeResult.code);
        }
    });
</script>
{% endcomment %}

{% endblock content %}